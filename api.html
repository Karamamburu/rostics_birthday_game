<%
var log_file_name = "server_request_from_game"

function Log(message, ex) {
  if(ex == null || ex == undefined) {
      LogEvent(log_file_name, message);
  } else {
      LogEvent(log_file_name, (message + ' Exception: ' + ex));
  }
}

EnableLog(log_file_name, true);

var curGameID = OptInt(7485300246935344434)
UniTools = OpenCodeLib(FilePathToUrl(AppDirectoryPath() + "/wtv/libs/custom_libs/uni_tools.js"));
Server.Execute(AppDirectoryPath() + "/wt/web/include/user_init.html" );

result = 'start_result'
try {
	request_body = tools.read_object(Request.Body);
	mode = request_body.GetOptProperty('mode', '')
	Log(mode)
} catch(ex) {
	Log("Err: " + ex)
}

Log(tools.object_to_text(request_body, 'json'));

switch (mode) {
	case 'game_over':
		gameResultDoc = tools.new_doc_by_name('cc_game_result', false)
		gameResultDoc.BindToDb()
		gameResultDoc.TopElem.name = 
			curUser.fullname + ' - ' + 
			request_body.GetOptProperty('game_code', '') + ' - ' + 
			request_body.GetOptProperty('start_time', '')
		gameResultDoc.TopElem.game_id = curGameID
		gameResultDoc.TopElem.game_name = request_body.GetOptProperty('game_code', '')
		gameResultDoc.TopElem.collaborator_id = curUserID
		gameResultDoc.TopElem.score = request_body.GetOptProperty('score', '')
		gameResultDoc.TopElem.difficulty_level = request_body.GetOptProperty('difficulty_level', '')
		gameResultDoc.TopElem.start_time = DateToLocalDate(OptDate(request_body.GetOptProperty('start_time', '')))
		gameResultDoc.TopElem.end_time = DateToLocalDate(OptDate(request_body.GetOptProperty('end_time', '')))
		gameResultDoc.TopElem.is_won = request_body.GetOptProperty('is_won', false)
		gameResultDoc.Save()
		Log("игра окончена");
		result = {name: 'The end'}
		break;
		
	case 'get_rating_data':
		Log("получить таблицу");
		
		function getTopResults(topNumber) {
			GetReadable = OpenCodeLib(FilePathToUrl(AppDirectoryPath() + "/wtv/libs/custom_libs/getReadable.js"));
			GetDataForLpe = OpenCodeLib(FilePathToUrl(AppDirectoryPath() + "/wtv/libs/custom_libs/get_data_for_lpe.js"));

			var query = "sql:
			SELECT TOP " + topNumber + "
				c.fullname,
				c.id,
				gr.difficulty_level, 
				gr.score, 
				gr.start_time, 
				gr.end_time, 
				gr.is_won
			FROM cc_game_results gr
			LEFT JOIN collaborators c ON c.id = gr.collaborator_id
			WHERE c.is_dismiss = 0
			ORDER BY gr.score DESC, DATEDIFF(second, gr.start_time, gr.end_time) ASC
			"
			var results= XQuery(query)

			var aResult = new Array()
			for (object in results) {
			try {
			
				newObj = new Object()
				newObj.fullname = GetReadable.getReadableShortName(object.fullname)
				newObj.position_name = GetReadable.getReadablePositionName(object.id)
				newObj.subdivision_name = GetReadable.getReadablePositionParentName(object.id)
				newObj.partner_name = GetDataForLpe.getPartnerName(object.id) == 'ИРБ' 
					? 'IRB Family' 
					: GetDataForLpe.getPartnerName(object.id) == 'МайРест' 
						? 'IRB Family' 
						: GetDataForLpe.getPartnerName(object.id) == 'РБП' 
							 ? 'IRB Family' 
							 : GetDataForLpe.getPartnerName(object.id)
				newObj.difficulty_level = object.difficulty_level
				newObj.score = object.score
				
				durationInSeconds = RawSecondsToDate(DateDiff(object.end_time, object.start_time))
				minutes = Minute(durationInSeconds)
				strSeconds = StrInt(Second(durationInSeconds))
				seconds = StrCharCount(strSeconds) == 2 ? strSeconds : 0 + strSeconds
				newObj.duration = minutes + ":" + seconds
				newObj.is_won = object.is_won
			} catch (ex) {
			   LogEvent(log_file_name, "Ошибка в обработке свойств объекта у сотрудника " + object.id + " " + GetReadable.getReadableShortName(object.fullname) + ": " + ex)
			}
				aResult.push(newObj)
			}

			return aResult
		}
		
		result = getTopResults(10)
		break;
}

Response.Write(EncodeJson(result))

Log("завершаем обработку");
EnableLog(log_file_name, false);

%>